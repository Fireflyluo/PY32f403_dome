## 数据链导航_v1.3
### 一、概述
本工程文为数传Offboard一体模块。主控PY32F403，射频模块SI24R1。
UART1 --> 数传接口
USB --> 上位机串口（当前版本为ch340_UART2） 
UART3 --> Offboard模式Mavlink协议输出接口
实现功能:点对点数传透传，Offboard模式Mavlink协议控制

### 二、文件结构

├── Application               -- 应用层代码目录
├── DSP                      
│   ├── Module_Driver         -- 外部设备的驱动库
│   │   ├── lcd                  -- lcd驱动
│   │   └── si24r1               -- 射频模块驱动
│   └── MCU_Driver            -- 片上外设的驱动             
├── firmware                  -- 固件代码
├── Middleware                --中间层代码
|   ├── Protocol                 --协议文件
|   ├── Network                  --网络层文件
|   └── Config                   --配置文件
├── Public                    --公共文件
├── MDK-ARM                   --工程文件
└── Readme.md                 --文档

### 三、工程说明   

#### 3.1 基本参数

工作于2.4G频段

基于国产芯片SI24R1 兼容NRF24L01 低成本 高性能

主控芯片PY32f403c1dt6 

使用USB串口与主机通信，双串口与飞控数传、Offboard接口通信。实现无线透传和外部控制。


#### 3.2 工作模式
该模块具有两种工作模式，一对一的透传模式和一对多的组网模式。

**透传模式**：第一次启动或复位后，模块通过启动顺序约定主从模式。

**组网模式**：需要用户指定主机，由主机分配各从机时隙、地址或信道。

#### 3.3 数据包格式

组网模式下，上位机与模块间通信需要符合特定数据包格式。模块会将上位机发送的数据包发送给对应模块ID的从机，并持续返回网络中各模块的数据。

##### 上位机串口发送的数据包格式：
| 包头 | 模块ID | 消息类型 | 消息序号 |  消息内容  | 包尾  |
|:----:|:-----:|:-------:| :------: | :-------: | :---:|
| 0xFF | 0-255 |  0-255  | 0-65535  |    DATA   | 0xEE  |
| 1Byte| 1Byte |  1Byte  |  2Byte   |  0-58Byte | 1Byte | 

##### 消息定义：
|  消息类型 | 含义 | 功能|
|:------:|:-----:| :-----:|
|  0x01  | 配置数据包 | 配置模块工作模式、发射功率、工作信道、空中速率、发射地址、接收地址|


#### 3.4 射频数据包格式
由于si24r1 一次最多发送 32 字节数据，因此，需要对数据包拆分为不同的数据帧。以下内容为射频链路层的介绍，并不暴露给上层，用于二次开发的说明。

**射频数据帧格式**：

| 控制字段 | 数据包序号| 消息内容|
|:-------:|:--------:| :-----: |
|  1Byte  |    1Byte |  0-30Byte | 

**控制字段位定义**：
|  帧类型\位    | 1  |   2  | 3 | 4 |  5  | 6   | 7 | 8 |
|:------------:|:--:|:----:|:-:|:-:|:---:|:---:|:-:|:-:|
| **信息帧(I)** | 0 | N(s) |    |  | P/F | N(R) |   |   |
| **监控帧(S)** | 1 |   0  | SS |  | P/F | N(R) |   |   |
| **控制帧(M)** | 1 |   1  | MM |  | P/F | MMM  |   |   |

**信息帧（I帧）**：标志为0。  N(S)是当前发送序号，N(R)是当前接收序号，P/F置1，表示本次数据帧需要从机发送监控帧响应（本项目中，该位也可表示模块工作模式，透传模式不需要从机回应）。

**监控帧（S帧）**：标志为10。 实现ARQ机制，用于接收方回应发送方（ACK）。
SS取值：
>-  00：接收准备（RR）。确认接收，准备接收下一帧。
>-  01：接收未就绪（NR）。确认接收未就绪，请求暂停下一帧。
>-  10：拒绝接收（REJ）。拒绝接收否认N（R）帧起的所有帧。
>-  11：选择拒绝接收（SREJ）。选择拒绝，只否认N(R)帧。

**控制帧（M帧）**：提供辅助的控制功能。最多可以定义32种控制命令。
1. SCM帧(set config Mode)
- 含义：用于设置从机参数配置。
- 控制字段：11 000
- 使用场景：在通信开始时，主站发送参数配置数据包，模块接收到数据包后，将 数据包中的参数配置到模块中。
  
2. RIM帧（Request Init Mode）
- 含义：用于请求初始化模式。
- 控制字段：11 001
- 使用场景：在链路恢复或重新配置时使用。






### 3.5 如何配置模块

通过主机向模块发送消息类型0x01的配置数据包，可以对SI24R1各项参数进行配置。

支持配置的参数：

1.模块模式（透传模式 or offboard模式）

2.模块发射功率（7个等级 不同的SI24R1芯片类别具体功率不同 请查阅数据手册）

3.模块工作信道（2400MHz~2525MHz 共126个 1MHz带宽的信道）

4.模块空速（250kbps 1Mbps 2Mbps 三种空中速率）

5.模块发射地址（5字节长度）

6.模块6个通道的接收地址




例子：FF 00 01 01 00 07 2D 11 AA BB CC DD EE 11 12 13 14 15 11 12 13 14 15  EE
模块0，配置数据包，包序号1，数据包内容（透传模式，功率7dB，信道45，空中速率2Mbps,发射地址AA BB CC DD EE，接收地址11 12 13 14 15，接收通道1 11，
接收通道2 12，接收通道3 13，接收通道4 14，接收通道5 15）
配置数据共19字节，具体格式定义如下：

| Mode  | Power | Channel | Speed |  Tx   |  R0   |  R1   |  R2   |  R3   |  R4   |  R5   |
| ----- | ----- | ------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 1Byte | 1Byte |  1Byte  | 1Byte | 5Byte | 5Byte | 1Byte | 1Byte | 1Byte | 1Byte | 1Byte |
各部分详细解释：

**ID** 模块ID **1Bytes**

**Mode** 工作模式 1Byte

| Value 数值   | 0           | 1           |
| ------------ | ----------- | ----------- |
| 模块工作模式  | 透传模式     | 数据包模式 |

**Power** 模块发射功率 1Byte

| Value 数值   | 0~7                |
| ------------ | ------------------ |
| 模块发射功率 | 发射功率等级 共8档 |

**Channel** 模块工作信道 1Byte

| Value 数值             | 0~125                            |
| ---------------------- | -------------------------------- |
| 模块工作信道(工作频率) | 共126个信道，对应2400MHz~2525MHz |

**Speed** 模块空中速率 1Byte

| Value 数值   | 0       | 1     | 2     |
| ------------ | ------- | ----- | ----- |
| 模块空中速率 | 250kbps | 1Mbps | 2Mbps |

**Tx** 模块发射地址 **5Bytes**

**R0** 模块接收通道0地址 **5Bytes**

**R1** 模块接收通道1地址最后一个字节 **1Byte**

**R2** 模块接收通道2地址最后一个字节 **1Byte**

**R3** 模块接收通道3地址最后一个字节 **1Byte**

**R4** 模块接收通道4地址最后一个字节 **1Byte**

**R5** 模块接收通道5地址最后一个字节 **1Byte**



####  模块配置注意事项

1.在一个信道内，若有多个模块同时发送，有可能会产生冲突，导致无法接收数据。

2.若两个模块之间想要通信，则必须处于相同的工作信道以及空速。

3.此模块工作在2.4G频段，有可能对周围的WIFI设备或者蓝牙设备产生干扰，若出现干扰可尝试切换信道。

4.要想发射和接收，则对应的发射地址和接收地址需要对应。

5.模块共有6个接收通道，也就是可以实现6个发射1个接收的星型网络。注意的是，只有接收通道0的5个字节的地址是可以自由指定的，接收通道1-5的前4个字节要求和接收通道0的前4个字节一致，也就是只能自由设置最后一个字节。



### 3.6 模块LED灯状态含义

模块含有两个独立的LED和一个电源指示灯（红灯），分别表示发送和接收的工作状态：

| 状态                | 含义                               |
| :------------------ | ---------------------------------- |
| 熄灭                | 模块初始化失败，存在硬件错误       |
| 绿色常亮             | 待定义                       |
| 黄色常亮             | 待定义                       |
| 绿灯闪烁             | 处于发送模式，并且正在发送数据     |
| 黄灯闪烁             | 处于发送模式，并且正在发送数据     |



### 3.7 模块其他功能

此模块有一块0.91存lcd屏幕。用来显示模块的当前状态，以及模块的当前配置信息。